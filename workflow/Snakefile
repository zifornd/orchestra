# Author: James Ashmore
# Copyright: Copyright 1010, James Ashmore
# Email: jashmore@ed.ac.uk
# License: MIT

configfile: "config/config.yml"

report: "report/workflow.rst"

rule all:
    input:
        # Experimental design
        # Droplet processing
        "results/droplet-processing/barcodeRanks.rds",
        "results/droplet-processing/barcodeRanksPlot.pdf",
        "results/droplet-processing/emptyDrops.rds",
        "results/droplet-processing/emptyDropsLimited.pdf",
        "results/droplet-processing/emptyDropsAmbient.rds",
        "results/droplet-processing/emptyDropsPValue.pdf",
        "results/droplet-processing/emptyDropsLogProb.pdf",
        "results/droplet-processing/emptyDropsRank.pdf",
        "results/droplet-processing/filterByDrops.rds",
        # Quality control
        "results/quality-control/perCellQCMetrics.rds",
        "results/quality-control/quickPerCellQC.rds",
        "results/quality-control/plotCellQCMetrics.sum.pdf",
        "results/quality-control/plotCellQCMetrics.detected.pdf",
        "results/quality-control/plotCellQCMetrics.MT.pdf",
        "results/quality-control/plotCellQCMetrics.sum.detected.pdf",
        "results/quality-control/plotCellQCMetrics.sum.MT.pdf",
        "results/quality-control/filterCellsByQC.rds",
        "results/quality-control/perFeatureQCMetrics.rds",
        "results/quality-control/plotFeatureQCMetrics.mean.pdf",
        "results/quality-control/plotFeatureQCMetrics.detected.pdf",
        "results/quality-control/plotMeanVsDetected.pdf",
        "results/quality-control/plotHighestExprs.pdf",
        # Normalization
        "results/normalization/librarySizeFactors.rds",
        "results/normalization/calculateSumFactors.rds",
        "results/normalization/compareSizeFactors.pdf",
        "results/normalization/logNormCounts.rds",
        # Feature selection
        "results/feature-selection/modelGeneVar.rds",
        "results/feature-selection/modelGeneCV2.rds",
        "results/feature-selection/modelGeneVarByPoisson.rds",
        "results/feature-selection/modelGeneVar.getTopHVGs.rds",
        "results/feature-selection/modelGeneCV2.getTopHVGs.rds",
        "results/feature-selection/modelGeneVarByPoisson.getTopHVGs.rds",
        "results/feature-selection/plotGeneVar.pdf",
        "results/feature-selection/plotGeneCV2.pdf",
        "results/feature-selection/plotGeneVarByPoisson.pdf",
        #"results/feature-selection/aggregateReference.rds",
        #"results/feature-selection/plotHeatmap.modelGeneVar.HVG.pdf",
        #"results/feature-selection/plotHeatmap.modelGeneCV2.HVG.pdf",
        #"results/feature-selection/plotHeatmap.modelGeneVarByPoisson.HVG.pdf",
        #"results/feature-selection/calculatePCA.modelGeneVar.HVG.rds",
        #"results/feature-selection/calculatePCA.modelGeneCV2.HVG.rds",
        #"results/feature-selection/calculatePCA.modelGeneVarByPoisson.HVG.rds",
        #"results/feature-selection/calculateTSNE.modelGeneVar.HVG.rds",
        #"results/feature-selection/calculateTSNE.modelGeneCV2.HVG.rds",
        #"results/feature-selection/calculateTSNE.modelGeneVarByPoisson.HVG.rds",
        #"results/feature-selection/calculateUMAP.modelGeneVar.HVG.rds",
        #"results/feature-selection/calculateUMAP.modelGeneCV2.HVG.rds",
        #"results/feature-selection/calculateUMAP.modelGeneVarByPoisson.HVG.rds",
        #"results/feature-selection/plotPCA.modelGeneVar.HVG.sum.pdf",
        #"results/feature-selection/plotPCA.modelGeneVar.HVG.detected.pdf",
        #"results/feature-selection/plotPCA.modelGeneCV2.HVG.sum.pdf",
        #"results/feature-selection/plotPCA.modelGeneCV2.HVG.detected.pdf",
        #"results/feature-selection/plotPCA.modelGeneVarByPoisson.HVG.sum.pdf",
        #"results/feature-selection/plotPCA.modelGeneVarByPoisson.HVG.detected.pdf",
        #"results/feature-selection/plotTSNE.modelGeneVar.HVG.sum.pdf",
        #"results/feature-selection/plotTSNE.modelGeneVar.HVG.detected.pdf",
        #"results/feature-selection/plotTSNE.modelGeneCV2.HVG.sum.pdf",
        #"results/feature-selection/plotTSNE.modelGeneCV2.HVG.detected.pdf",
        #"results/feature-selection/plotTSNE.modelGeneVarByPoisson.HVG.sum.pdf",
        #"results/feature-selection/plotTSNE.modelGeneVarByPoisson.HVG.detected.pdf",
        #"results/feature-selection/plotUMAP.modelGeneVar.HVG.sum.pdf",
        #"results/feature-selection/plotUMAP.modelGeneVar.HVG.detected.pdf",
        #"results/feature-selection/plotUMAP.modelGeneCV2.HVG.sum.pdf",
        #"results/feature-selection/plotUMAP.modelGeneCV2.HVG.detected.pdf",
        #"results/feature-selection/plotUMAP.modelGeneVarByPoisson.HVG.sum.pdf",
        #"results/feature-selection/plotUMAP.modelGeneVarByPoisson.HVG.detected.pdf",
        "results/feature-selection/rowSubset.rds",
        # Dimensionality reduction
        "results/reduced-dimensions/calculatePCA.rds",
        "results/reduced-dimensions/findElbowPoint.rds",
        "results/reduced-dimensions/plotElbowPoint.pdf",
        "results/reduced-dimensions/getDenoisedPCs.rds",
        "results/reduced-dimensions/plotDenoisedPCs.pdf",
        "results/reduced-dimensions/getClusteredPCs.rds",
        "results/reduced-dimensions/plotClusteredPCs.pdf",
        "results/reduced-dimensions/selectPCA.rds",
        "results/reduced-dimensions/parallelTSNE.rds",
        "results/reduced-dimensions/visualiseTSNE.pdf",
        "results/reduced-dimensions/parallelUMAP.rds",
        "results/reduced-dimensions/visualiseUMAP.pdf",
        "results/reduced-dimensions/selectTSNE.rds",
        "results/reduced-dimensions/selectUMAP.rds",
        "results/reduced-dimensions/plotPCA.sum.pdf",
        "results/reduced-dimensions/plotPCA.detected.pdf",
        "results/reduced-dimensions/plotTSNE.sum.pdf",
        "results/reduced-dimensions/plotTSNE.detected.pdf",
        "results/reduced-dimensions/plotUMAP.sum.pdf",
        "results/reduced-dimensions/plotUMAP.detected.pdf",
        "results/reduced-dimensions/reducedDims.rds",
        # Clustering
        "results/clustering/NNGraphParam.10.jaccard.louvain.rds",
        "results/clustering/NNGraphPCAPlot.10.jaccard.louvain.pdf",
        "results/clustering/NNGraphTSNEPlot.10.jaccard.louvain.pdf",
        "results/clustering/NNGraphUMAPPlot.10.jaccard.louvain.pdf",
        "results/clustering/NNGraphSilhouette.10.jaccard.louvain.rds",
        "results/clustering/NNGraphSilhouettePlot.10.jaccard.louvain.pdf",
        "results/clustering/NNGraphPurity.10.jaccard.louvain.rds",
        "results/clustering/NNGraphPurityPlot.10.jaccard.louvain.pdf",
        "results/clustering/NNGraphModularity.10.jaccard.louvain.rds",
        "results/clustering/NNGraphModularityPlot.10.jaccard.louvain.pdf",
        "results/clustering/clusterLabels.rds",
        # Doublet detection
        "results/doublet-detection/findDoubletClusters.rds",
        "results/doublet-detection/computeDoubletDensity.rds",
        "results/doublet-detection/scDblFinder.rds",
        "results/doublet-detection/colDoublets.rds",
        "results/doublet-detection/plotDoubletSina.pdf",
        #"results/doublet-detection/plotDoubletPCA.pdf",
        #"results/doublet-detection/plotDoubletTSNE.pdf",
        #"results/doublet-detection/plotDoubletUMAP.pdf",
        # Cell cycle assignment
        "results/cell-cycle/plotCyclins.pdf",
        "results/cell-cycle/cyclone.rds",
        "results/cell-cycle/addPerCellPhase.rds",
        "results/cell-cycle/plotCyclone.pdf",
        "results/cell-cycle/plotPhaseSina.pdf",
        #"results/cell-cycle/plotPhasePCA.pdf",
        #"results/cell-cycle/plotPhaseTSNE.pdf",
        #"results/cell-cycle/plotPhaseUMAP.pdf",
        # Marker gene detection
        #"results/marker-detection/aggregateReference.rds",
        "results/marker-detection/pairwiseTTests.any.0.rds",
        "results/marker-detection/combineTTests.any.0.all.rds",
        "results/marker-detection/writeTTests.any.0.all",
        "results/marker-detection/plotTTestsEffects.any.0.all",
        "results/marker-detection/heatmapTTests.any.0.all.pdf",
        "results/marker-detection/pairwiseWilcox.any.0.rds",
        "results/marker-detection/combineWilcox.any.0.all.rds",
        "results/marker-detection/writeWilcox.any.0.all",
        "results/marker-detection/plotWilcoxEffects.any.0.all",
        "results/marker-detection/heatmapWilcox.any.0.all.pdf",
        "results/marker-detection/pairwiseBinom.any.0.rds",
        "results/marker-detection/combineBinom.any.0.all.rds",
        "results/marker-detection/writeBinom.any.0.all",
        "results/marker-detection/plotBinomEffects.any.0.all",
        "results/marker-detection/heatmapBinom.any.0.all.pdf",
        # Cell annotation
        "results/cell-annotation/GeneSetCollection.rds",
        "results/cell-annotation/buildRankings.rds",
        "results/cell-annotation/calcAUC.rds",
        "results/cell-annotation/exploreThresholds.pdf",
        "results/cell-annotation/GOALL.rds",
        "results/cell-annotation/sumCountsAcrossFeatures.rds",
        "results/cell-annotation/heatmap.pdf",
        "results/cell-annotation/goana.rds",
        "results/cell-annotation/plotGOTerms.pdf",
        # Trajectory
        "results/trajectory/aggregateAcrossCells.rds",
        "results/trajectory/createClusterMST.rds",
        "results/trajectory/reportEdges.PCA.rds",
        "results/trajectory/reportEdges.TSNE.rds",
        "results/trajectory/reportEdges.UMAP.rds",
        "results/trajectory/plotEdges.PCA.pdf",
        "results/trajectory/plotEdges.TSNE.pdf",
        "results/trajectory/plotEdges.UMAP.pdf",
        "results/trajectory/slingshot.rds",
        "results/trajectory/slingPseudotime.rds",
        "results/trajectory/embedCurves.PCA.rds",
        "results/trajectory/embedCurves.TSNE.rds",
        "results/trajectory/embedCurves.UMAP.rds",
        "results/trajectory/slingCurves.PCA.rds",
        "results/trajectory/slingCurves.TSNE.rds",
        "results/trajectory/slingCurves.UMAP.rds",
        "results/trajectory/plotCurves.PCA.pdf",
        "results/trajectory/plotCurves.TSNE.pdf",
        "results/trajectory/plotCurves.UMAP.pdf",
        "results/trajectory/testPseudotime.rds",
        "results/trajectory/perCellEntropy.rds",
        "results/trajectory/plotEntropy.pdf",
        #"results/trajectory/scvelo.rds",
        #"results/trajectory/embedVelocity.PCA.rds",
        #"results/trajectory/embedVelocity.TSNE.rds",
        #"results/trajectory/embedVelocity.UMAP.rds",
        #"results/trajectory/gridVectors.PCA.rds",
        #"results/trajectory/gridVectors.TSNE.rds",
        #"results/trajectory/gridVectors.UMAP.rds",
        #"results/trajectory/plotVeloPCA.pdf",
        #"results/trajectory/plotVeloTSNE.pdf",
        #"results/trajectory/plotVeloUMAP.pdf"

# Workflow rules
include: "rules/droplet-processing.smk"
include: "rules/quality-control.smk"
include: "rules/normalization.smk"
include: "rules/feature-selection.smk"
include: "rules/reduced-dimensions.smk"
include: "rules/clustering.smk"
include: "rules/doublet-detection.smk"
include: "rules/cell-cycle.smk"
include: "rules/marker-detection.smk"
include: "rules/cell-annotation.smk"
include: "rules/trajectory.smk"
